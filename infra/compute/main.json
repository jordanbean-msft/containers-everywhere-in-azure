{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1124.51302",
      "templateHash": "4492401635810573576"
    }
  },
  "parameters": {
    "appName": {
      "type": "string"
    },
    "environment": {
      "type": "string"
    },
    "location": {
      "type": "string"
    },
    "containerRegistryName": {
      "type": "string"
    },
    "appImageName": {
      "type": "string"
    },
    "apiImageName": {
      "type": "string"
    },
    "storageAccountName": {
      "type": "string"
    },
    "logAnalyticsWorkspaceName": {
      "type": "string"
    },
    "appInsightsName": {
      "type": "string"
    },
    "managedIdentityName": {
      "type": "string"
    }
  },
  "variables": {
    "longName": "[format('{0}-{1}-{2}', parameters('appName'), parameters('location'), parameters('environment'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "appServiceDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "containerRegistryName": {
            "value": "[parameters('containerRegistryName')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[parameters('logAnalyticsWorkspaceName')]"
          },
          "longName": {
            "value": "[variables('longName')]"
          },
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "appInsightsName": {
            "value": "[parameters('appInsightsName')]"
          },
          "managedIdentityName": {
            "value": "[parameters('managedIdentityName')]"
          },
          "appImageName": {
            "value": "[parameters('appImageName')]"
          },
          "apiImageName": {
            "value": "[parameters('apiImageName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "13166808592070985865"
            }
          },
          "parameters": {
            "containerRegistryName": {
              "type": "string"
            },
            "longName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string"
            },
            "appInsightsName": {
              "type": "string"
            },
            "managedIdentityName": {
              "type": "string"
            },
            "appImageName": {
              "type": "string"
            },
            "apiImageName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2021-02-01",
              "name": "[format('asp-{0}', parameters('longName'))]",
              "location": "[resourceGroup().location]",
              "sku": {
                "name": "F1",
                "tier": "Free",
                "capacity": 0
              },
              "kind": "linux",
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-02-01",
              "name": "[format('as-app-{0}', parameters('longName'))]",
              "location": "[resourceGroup().location]",
              "kind": "app,linux,container",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')))]": {}
                }
              },
              "properties": {
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "DOCKER_REGISTRY_SERVER_URL",
                      "value": "[parameters('containerRegistryName')]"
                    },
                    {
                      "name": "DOCKER_REGISTRY_SERVER_USERNAME",
                      "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2021-06-01-preview').username]"
                    },
                    {
                      "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                      "value": "false"
                    }
                  ]
                },
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('asp-{0}', parameters('longName')))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('asp-{0}', parameters('longName')))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/web', format('as-app-{0}', parameters('longName')))]",
              "properties": {
                "linuxFxVersion": "[format('DOCKER|{0}', parameters('appImageName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', format('as-app-{0}', parameters('longName')))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-02-01",
              "name": "[format('as-api-{0}', parameters('longName'))]",
              "location": "[resourceGroup().location]",
              "kind": "app,linux,container",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')))]": {}
                }
              },
              "properties": {
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "DOCKER_REGISTRY_SERVER_URL",
                      "value": "[parameters('containerRegistryName')]"
                    },
                    {
                      "name": "DOCKER_REGISTRY_SERVER_USERNAME",
                      "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2021-06-01-preview').username]"
                    },
                    {
                      "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                      "value": "false"
                    }
                  ]
                },
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('asp-{0}', parameters('longName')))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('asp-{0}', parameters('longName')))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/web', format('as-api-{0}', parameters('longName')))]",
              "properties": {
                "linuxFxVersion": "[format('DOCKER|{0}', parameters('apiImageName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', format('as-api-{0}', parameters('longName')))]"
              ]
            }
          ],
          "outputs": {
            "appServicePlanName": {
              "type": "string",
              "value": "[format('asp-{0}', parameters('longName'))]"
            },
            "appServiceName": {
              "type": "string",
              "value": "[format('as-app-{0}', parameters('longName'))]"
            },
            "apiServiceName": {
              "type": "string",
              "value": "[format('as-api-{0}', parameters('longName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "aksDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "containerRegistryName": {
            "value": "[parameters('containerRegistryName')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[parameters('logAnalyticsWorkspaceName')]"
          },
          "longName": {
            "value": "[variables('longName')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "appInsightsName": {
            "value": "[parameters('appInsightsName')]"
          },
          "managedIdentityName": {
            "value": "[parameters('managedIdentityName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "3812034051668495407"
            }
          },
          "parameters": {
            "containerRegistryName": {
              "type": "string"
            },
            "longName": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string"
            },
            "managedIdentityName": {
              "type": "string"
            },
            "appInsightsName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerService/managedClusters",
              "apiVersion": "2021-07-01",
              "name": "[format('aks-{0}', parameters('longName'))]",
              "location": "[resourceGroup().location]",
              "sku": {
                "name": "Basic",
                "tier": "Free"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')))]": {}
                }
              },
              "properties": {
                "agentPoolProfiles": [
                  {
                    "name": "agentpool",
                    "count": 1,
                    "vmSize": "Standard_DS2_v2",
                    "osDiskSizeGB": 60,
                    "osDiskType": "Ephemeral",
                    "type": "VirtualMachineScaleSets",
                    "enableAutoScaling": true,
                    "osType": "Linux",
                    "osSKU": "Ubuntu",
                    "minCount": 1,
                    "maxCount": 5,
                    "mode": "System"
                  }
                ],
                "addonProfiles": {
                  "azurepolicy": {
                    "enabled": true
                  },
                  "omsAgent": {
                    "enabled": true,
                    "config": {
                      "logAnalyticsWorkspaceResourceID": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
                    }
                  }
                },
                "enableRBAC": true,
                "dnsPrefix": "[parameters('longName')]",
                "nodeResourceGroup": "[format('rg-{0}-aks', parameters('appName'))]"
              }
            }
          ],
          "outputs": {
            "aksName": {
              "type": "string",
              "value": "[format('aks-{0}', parameters('longName'))]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "aksName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'aksDeployment'), '2020-10-01').outputs.aksName.value]"
    },
    "appServiceName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServiceDeployment'), '2020-10-01').outputs.appServiceName.value]"
    },
    "apiServiceName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServiceDeployment'), '2020-10-01').outputs.apiServiceName.value]"
    }
  }
}